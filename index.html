<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>South Shields Metro Times</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #predicted-departure {
            background: #3498db;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 2em;
            text-align: center;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        #last-updated {
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        /* Metro Updates Section */
        .metro-updates {
            background: #fff;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 24px;
            margin-top: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metro-updates h2 {
            margin: 0 0 16px 0;
            color: #2c3e50;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-good { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }
        .status-loading { background-color: #95a5a6; }
        
        .loading {
            color: #7f8c8d;
            padding: 20px;
            text-align: center;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .update-content {
            color: #2c3e50;
            line-height: 1.6;
            font-size: 1em;
        }
        
        .error {
            color: #e74c3c;
            padding: 16px;
            background-color: #fadbd8;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
        }
        
        .updates-timestamp {
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ecf0f1;
        }
        
        .refresh-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 12px;
        }
        
        .refresh-button:hover {
            background: #2980b9;
        }
        
        .refresh-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .powered-by {
            font-size: 0.8em;
            color: #95a5a6;
            margin-top: 12px;
            text-align: right;
        }
    </style>
</head>
<body>
    <h1>South Shields Metro Departures</h1>
    <div id="predicted-departure">
        Predicted next departure time: <span id="prediction-time">Calculating...</span>
    </div>
    <div class="container">
        <div class="card">
            <h2>Live Arrivals</h2>
            <div id="departures">Loading...</div>
        </div>
        <div class="card">
            <h2>Next Scheduled Times</h2>
            <div id="scheduled-times">Loading...</div>
        </div>
    </div>
    <div id="last-updated">Last updated: Never</div>

    <!-- NEW: Claude-Powered Service Updates -->
    <div class="metro-updates">
        <h2>
            <span class="status-indicator status-loading" id="statusIndicator"></span>
            Service Status & Analysis
        </h2>
        <div id="updateContent" class="loading">Analyzing South Shields service</div>
        <button id="refreshButton" class="refresh-button" style="display:none;">Refresh Analysis</button>
        <div class="updates-timestamp" id="updatesTimestamp" style="display:none;"></div>
        <div class="powered-by">AI-powered analysis by Claude</div>
    </div>

    <script>
        // Complete Nexus timetable data for Platform 2
        const schedules = {
            weekday: {
                5: [44,56],
                6: [8,20,32,44,56],
                7: [8,20,32,44,56],
                8: [8,20,32,44,56],
                9: [8,20,32,44,56],
                10: [8,20,32,44,56],
                11: [8,20,32,44,56],
                12: [8,20,32,44,56],
                13: [8,20,32,44,56],
                14: [8,20,32,44,56],
                15: [8,20,30,44,56],
                16: [8,20,32,44,56],
                17: [8,20,32,44,56],
                18: [11,26,35,41,56],
                19: [11,26,41,56],
                20: [11,26,41,56],
                21: [11,26,41,56],
                22: [11,26,41,56],
                23: [11,26,41,56]
            },
            saturday: {
                6: [56],
                7: [26,56],
                8: [26,56],
                9: [26,56],
                10: [11,26,41,56],
                11: [11,26,41,56],
                12: [11,26,41,56],
                13: [11,26,41,56],
                14: [11,26,41,56],
                15: [11,26,41,56],
                16: [11,26,41,56],
                17: [11,26,41,56],
                18: [11,26,41,56],
                19: [11,26,41,56],
                20: [11,26,41,56],
                21: [11,26,41,56],
                22: [11,26,41,56],
                23: [11,26,41,56]
            },
            sunday: {
                6: [56],
                7: [26,56],
                8: [26,56],
                9: [26,56],
                10: [11,26,41,56],
                11: [11,26,41,56],
                12: [11,26,41,56],
                13: [11,26,41,56],
                14: [11,26,41,56],
                15: [11,26,41,56],
                16: [11,26,41,56],
                17: [11,26,41,56],
                18: [11,26,41,56],
                19: [11,26,41,56],
                20: [11,26,41,56],
                21: [11,26,41,56],
                22: [11,26,41,56],
                23: [11,26,41,56]
            }
        };

        function getScheduleForDay() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            if (dayOfWeek === 0) return schedules.sunday;
            if (dayOfWeek === 6) return schedules.saturday;
            return schedules.weekday;
        }

        function getNextScheduledTimes() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const schedule = getScheduleForDay();
            
            let upcomingTimes = [];
            
            // Check current hour first
            if (schedule[currentHour]) {
                const validMinutes = schedule[currentHour].filter(m => m > currentMinute);
                upcomingTimes.push(...validMinutes.map(m => ({
                    hour: currentHour,
                    minute: m
                })));
            }
            
            // Check subsequent hours if needed
            let hour = currentHour + 1;
            while (upcomingTimes.length < 4 && hour <= 23) {
                if (schedule[hour]) {
                    upcomingTimes.push(...schedule[hour].map(m => ({
                        hour: hour,
                        minute: m
                    })));
                }
                hour++;
            }
            
            return upcomingTimes.slice(0, 4);
        }

        function displayScheduledTimes() {
            const scheduledDiv = document.getElementById('scheduled-times');
            const nextTimes = getNextScheduledTimes();
            
            if (nextTimes.length === 0) {
                scheduledDiv.innerHTML = 'No more scheduled departures today';
                return;
            }
            
            scheduledDiv.innerHTML = nextTimes
                .map(time => 
                    `${time.hour.toString().padStart(2, '0')}:${time.minute.toString().padStart(2, '0')}`
                ).join('<br>');
        }

        async function fetchPrediction() {
            try {
                const response = await fetch('https://metro-rti.nexus.org.uk/api/times/CHI/2', {
                    headers: { "User-Agent": "okhttp/3.12.1" }
                });

                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                
                const data = await response.json();
                
                if (data.length > 0) {
                    const nextTrain = data[0];
                    const now = new Date();
                    const predictedTime = new Date(now.getTime() + (nextTrain.dueIn - 2) * 60000);
                    document.getElementById('prediction-time').textContent = 
                        `${predictedTime.getHours().toString().padStart(2, '0')}:${predictedTime.getMinutes().toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('prediction-time').textContent = 'No departures';
                }

            } catch (error) {
                document.getElementById('prediction-time').textContent = 'Unavailable';
            }
        }

        async function fetchDepartures() {
            try {
                const response = await fetch('https://metro-rti.nexus.org.uk/api/times/SSS/2', {
                    headers: { "User-Agent": "okhttp/3.12.1" }
                });

                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                
                const data = await response.json();
                const departuresContainer = document.getElementById('departures');
                
                departuresContainer.innerHTML = data.length > 0 
                    ? data.map(d => `<div>Train ${d.trn}: ${d.dueIn == 0 ? "Due" : (d.dueIn < 0 ? "Arrived" : `Due in ${d.dueIn} mins`)}</div>`).join('')
                    : 'No live departures available';

                document.getElementById('last-updated').textContent =
                    `Last updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                document.getElementById("departures").innerHTML =
                    `Live departures unavailable: ${error.message}`;
            }
        }

        // NEW: Claude AI Service Analysis
        let isAnalyzing = false;

        async function analyzeServiceWithClaude() {
            if (isAnalyzing) return;
            
            isAnalyzing = true;
            const contentDiv = document.getElementById('updateContent');
            const statusIndicator = document.getElementById('statusIndicator');
            const refreshButton = document.getElementById('refreshButton');
            const timestampDiv = document.getElementById('updatesTimestamp');
            
            contentDiv.className = 'loading';
            contentDiv.textContent = 'Analyzing South Shields service';
            statusIndicator.className = 'status-indicator status-loading';
            refreshButton.disabled = true;
            timestampDiv.style.display = 'none';

            try {
                // Fetch live data for South Shields
                const response = await fetch('https://metro-rti.nexus.org.uk/api/times/SSS/2', {
                    headers: { "User-Agent": "okhttp/3.12.1" }
                });

                if (!response.ok) throw new Error('Failed to fetch live data');
                
                const liveData = await response.json();
                
                // Get current time and scheduled times
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const schedule = getScheduleForDay();
                const dayType = now.getDay() === 0 ? 'Sunday' : (now.getDay() === 6 ? 'Saturday' : 'Weekday');
                
                // Find what should be running now
                const nextScheduled = getNextScheduledTimes();
                
                // Use Claude AI to analyze the data
                const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `You are analyzing metro service for South Shields station. Provide a brief, friendly update.

Current time: ${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}
Day type: ${dayType}

LIVE DEPARTURE DATA from South Shields (Platform 2):
${JSON.stringify(liveData, null, 2)}

SCHEDULED TIMES for next 4 departures:
${nextScheduled.map(t => `${t.hour.toString().padStart(2, '0')}:${t.minute.toString().padStart(2, '0')}`).join(', ')}

INSTRUCTIONS:
1. Check if trains are running on time by comparing live data with scheduled times
2. If there are delays, calculate how many minutes late trains are
3. If there are no live departures when there should be, note this as a potential issue
4. Keep response to 2-3 sentences maximum
5. Be specific about South Shields station
6. If everything is normal, say so briefly

Focus on: Are services running to schedule? If not, by how much are they delayed?`
                        }]
                    })
                });

                if (!claudeResponse.ok) {
                    throw new Error('Failed to get AI analysis');
                }

                const claudeData = await claudeResponse.json();
                const updateText = claudeData.content[0].text;

                // Determine status based on the response
                let statusClass = 'status-good';
                const lowerText = updateText.toLowerCase();
                if (lowerText.includes('delay') || lowerText.includes('late') || lowerText.includes('behind schedule')) {
                    statusClass = 'status-warning';
                }
                if (lowerText.includes('no trains') || lowerText.includes('suspended') || lowerText.includes('not running') || lowerText.includes('cancelled')) {
                    statusClass = 'status-error';
                }

                // Update UI
                contentDiv.className = 'update-content';
                contentDiv.textContent = updateText;
                statusIndicator.className = `status-indicator ${statusClass}`;
                
                // Show timestamp
                timestampDiv.textContent = `Analysis updated: ${now.toLocaleTimeString('en-GB')}`;
                timestampDiv.style.display = 'block';
                
            } catch (error) {
                console.error('Error analyzing service:', error);
                contentDiv.className = 'error';
                contentDiv.textContent = '⚠️ Unable to analyze service at the moment. Live departure times are still available above.';
                statusIndicator.className = 'status-indicator';
            } finally {
                isAnalyzing = false;
                refreshButton.disabled = false;
                refreshButton.style.display = 'block';
            }
        }

        // Initial load
        displayScheduledTimes();
        fetchDepartures();
        fetchPrediction();
        analyzeServiceWithClaude(); // NEW: Initial AI analysis

        // Update every 15 seconds for departures
        setInterval(() => {
            displayScheduledTimes();
            fetchDepartures();
            fetchPrediction();
        }, 15000);

        // Update AI analysis every 3 minutes (less frequent as it's more resource intensive)
        setInterval(analyzeServiceWithClaude, 3 * 60 * 1000);

        // Refresh button for AI analysis
        document.getElementById('refreshButton').addEventListener('click', analyzeServiceWithClaude);
    </script>
</body>
</html>
